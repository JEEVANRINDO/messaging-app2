<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GhostMesh | Secure Messaging</title>
    
    <!-- More reliable CDN for PeerJS -->
    <script src="https://cdn.jsdelivr.net/npm/peerjs@1.5.2/dist/peerjs.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0b141a;
            color: #e9edef;
            height: 100vh;
            overflow: hidden;
        }
        
        .hidden {
            display: none !important;
        }
        
        /* Onboarding */
        #onboarding {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #111b21 0%, #0a1017 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }
        
        .onboarding-content {
            max-width: 400px;
            width: 100%;
            text-align: center;
        }
        
        .logo {
            font-size: 48px;
            margin-bottom: 20px;
        }
        
        h1 {
            font-size: 28px;
            margin-bottom: 10px;
            color: white;
        }
        
        .subtitle {
            color: #8696a0;
            margin-bottom: 40px;
        }
        
        input {
            width: 100%;
            padding: 15px;
            margin-bottom: 15px;
            background: #2a3942;
            border: 1px solid #3d4b53;
            border-radius: 8px;
            color: white;
            font-size: 16px;
        }
        
        input:focus {
            outline: none;
            border-color: #00a884;
        }
        
        button {
            width: 100%;
            padding: 15px;
            background: #00a884;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        button:hover {
            background: #008f6f;
        }
        
        button:disabled {
            background: #2a3942;
            cursor: not-allowed;
        }
        
        /* Main App */
        .app-container {
            display: flex;
            height: 100vh;
        }
        
        /* Sidebar */
        .sidebar {
            width: 400px;
            background: #111b21;
            border-right: 1px solid #2a3942;
            display: flex;
            flex-direction: column;
        }
        
        .user-header {
            padding: 15px;
            background: #202c33;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .avatar {
            width: 40px;
            height: 40px;
            background: #00a884;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            font-size: 14px;
        }
        
        .user-info h3 {
            font-size: 16px;
            margin-bottom: 3px;
        }
        
        .status {
            font-size: 12px;
            color: #8696a0;
        }
        
        .search {
            padding: 15px;
            background: #111b21;
        }
        
        .search input {
            width: 100%;
            padding: 10px 15px;
            background: #202c33;
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 14px;
        }
        
        .contacts {
            flex: 1;
            overflow-y: auto;
        }
        
        .contact {
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
            border-bottom: 1px solid #2a3942;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .contact:hover {
            background: #202c33;
        }
        
        .contact.active {
            background: #2a3942;
        }
        
        .contact-avatar {
            width: 50px;
            height: 50px;
            background: #3d4b53;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            font-size: 16px;
        }
        
        .contact-info {
            flex: 1;
            min-width: 0;
        }
        
        .contact-name {
            font-weight: 600;
            margin-bottom: 3px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .contact-last {
            font-size: 13px;
            color: #8696a0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        /* Chat Area */
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #0b141a;
        }
        
        .chat-header {
            padding: 15px;
            background: #202c33;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #2a3942;
        }
        
        .chat-contact {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .message {
            max-width: 70%;
            padding: 10px 15px;
            border-radius: 8px;
            position: relative;
            word-wrap: break-word;
        }
        
        .message.sent {
            background: #005c4b;
            align-self: flex-end;
            border-top-right-radius: 0;
        }
        
        .message.received {
            background: #202c33;
            align-self: flex-start;
            border-top-left-radius: 0;
        }
        
        .message-time {
            font-size: 11px;
            color: rgba(255,255,255,0.6);
            margin-top: 5px;
            text-align: right;
        }
        
        .file-message {
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            margin-top: 5px;
        }
        
        .file-info {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px;
        }
        
        .file-icon {
            width: 40px;
            height: 40px;
            background: #3d4b53;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            font-size: 18px;
        }
        
        .file-details {
            flex: 1;
            min-width: 0;
        }
        
        .file-name {
            font-weight: 600;
            margin-bottom: 3px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .file-size {
            font-size: 12px;
            color: #8696a0;
        }
        
        .download-btn {
            padding: 6px 12px;
            background: #00a884;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            white-space: nowrap;
        }
        
        .image-message {
            max-width: 300px;
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
        }
        
        .image-message img {
            width: 100%;
            height: auto;
            display: block;
        }
        
        .input-area {
            padding: 15px;
            background: #202c33;
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }
        
        textarea {
            flex: 1;
            background: #2a3942;
            border: none;
            border-radius: 8px;
            padding: 12px 15px;
            color: white;
            font-size: 15px;
            resize: none;
            min-height: 44px;
            max-height: 120px;
            font-family: inherit;
        }
        
        textarea:focus {
            outline: none;
        }
        
        .send-btn {
            width: 44px;
            height: 44px;
            background: #00a884;
            border: none;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }
        
        /* Toast */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #202c33;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            z-index: 1000;
            animation: fadeInOut 3s ease-in-out;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            border: 1px solid #2a3942;
        }
        
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateX(-50%) translateY(20px); }
            10% { opacity: 1; transform: translateX(-50%) translateY(0); }
            90% { opacity: 1; transform: translateX(-50%) translateY(0); }
            100% { opacity: 0; transform: translateX(-50%) translateY(20px); }
        }
        
        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            color: #8696a0;
        }
        
        /* Error */
        .error {
            background: #4a1e1e;
            color: #ff6b6b;
            padding: 10px 15px;
            border-radius: 8px;
            margin: 10px;
            font-size: 14px;
        }
        
        /* Welcome screen */
        .welcome {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            text-align: center;
            padding: 20px;
            color: #8696a0;
        }
        
        .welcome-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.5;
        }
        
        .welcome h2 {
            font-size: 24px;
            margin-bottom: 10px;
            color: white;
        }
        
        /* Connection status */
        .connection-status {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 12px;
        }
        
        .status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
        }
        
        .status-dot.online {
            background: #00a884;
            box-shadow: 0 0 8px #00a884;
        }
        
        .status-dot.offline {
            background: #8696a0;
        }
        
        .status-dot.connecting {
            background: #ffa500;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body>
    <!-- Onboarding Screen -->
    <div id="onboarding">
        <div class="onboarding-content">
            <div class="logo">üîí</div>
            <h1>GhostMesh Secure</h1>
            <div class="subtitle">End-to-End Encrypted Messaging</div>
            
            <input type="text" id="setup-name" placeholder="Your Name" autocomplete="off">
            <input type="password" id="setup-password" placeholder="Password" autocomplete="new-password">
            
            <button id="create-profile">Get Started</button>
            
            <div id="setup-error" class="error hidden" style="margin-top: 15px;"></div>
        </div>
    </div>

    <!-- Main App -->
    <div id="app" class="hidden">
        <div class="app-container">
            <!-- Sidebar -->
            <div class="sidebar">
                <div class="user-header">
                    <div class="avatar" id="my-avatar">ME</div>
                    <div class="user-info">
                        <h3 id="my-name">Loading...</h3>
                        <div class="connection-status">
                            <div class="status-dot offline" id="status-dot"></div>
                            <span id="network-status">Offline</span>
                        </div>
                    </div>
                </div>
                
                <div class="search">
                    <input type="text" id="search-contacts" placeholder="Search contacts...">
                </div>
                
                <div class="contacts" id="contacts-list">
                    <div class="loading" id="contacts-loading">Loading contacts...</div>
                    <!-- Contacts will be added here -->
                </div>
            </div>

            <!-- Chat Area -->
            <div class="chat-area" id="chat-area">
                <!-- Welcome/Empty State -->
                <div class="welcome" id="welcome-screen">
                    <div class="welcome-icon">üí¨</div>
                    <h2>Welcome to GhostMesh</h2>
                    <p>Select a contact to start messaging</p>
                    <p style="margin-top: 20px; font-size: 14px;">
                        Your ID: <code id="my-id-display">Loading...</code>
                    </p>
                    <button onclick="copyMyId()" style="margin-top: 15px; width: auto; padding: 8px 16px; font-size: 14px;">
                        Copy My ID
                    </button>
                </div>

                <!-- Active Chat -->
                <div id="active-chat" class="hidden">
                    <div class="chat-header">
                        <div class="chat-contact">
                            <div class="avatar" id="chat-avatar">?</div>
                            <div>
                                <div id="chat-name">Contact</div>
                                <div class="status" id="chat-status">Offline</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="messages" id="messages-container">
                        <!-- Messages will be added here -->
                    </div>
                    
                    <div class="input-area">
                        <textarea id="message-input" placeholder="Type a message..." rows="1"></textarea>
                        <button class="send-btn" id="send-btn" onclick="sendMessage()">‚û§</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // App State
        const AppState = {
            id: null,
            name: null,
            password: null,
            activeChat: null,
            contacts: {},
            messages: {},
            peer: null,
            connections: {},
            isOnline: false
        };

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            console.log("DOM loaded, initializing app...");
            
            // Check for saved profile
            const savedName = localStorage.getItem('ghostmesh_name');
            const savedId = localStorage.getItem('ghostmesh_id');
            
            if (savedName && savedId) {
                // Load existing profile
                AppState.name = savedName;
                AppState.id = savedId;
                AppState.password = localStorage.getItem('ghostmesh_password') || '';
                AppState.contacts = JSON.parse(localStorage.getItem('ghostmesh_contacts') || '{}');
                AppState.messages = JSON.parse(localStorage.getItem('ghostmesh_messages') || '{}');
                
                showApp();
                initializeNetwork();
            } else {
                // Show onboarding
                showOnboarding();
            }
        });

        // Show onboarding screen
        function showOnboarding() {
            document.getElementById('onboarding').classList.remove('hidden');
            document.getElementById('app').classList.add('hidden');
            
            document.getElementById('create-profile').onclick = createProfile;
            
            // Allow Enter key to submit
            document.getElementById('setup-password').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    createProfile();
                }
            });
        }

        // Create profile
        function createProfile() {
            const name = document.getElementById('setup-name').value.trim();
            const password = document.getElementById('setup-password').value;
            const errorDiv = document.getElementById('setup-error');
            
            errorDiv.classList.add('hidden');
            
            if (!name || name.length < 2) {
                showError(errorDiv, "Name must be at least 2 characters");
                return;
            }
            
            if (!password || password.length < 4) {
                showError(errorDiv, "Password must be at least 4 characters");
                return;
            }
            
            // Generate unique ID
            const id = generateUserId();
            
            // Save to AppState
            AppState.name = name;
            AppState.password = password;
            AppState.id = id;
            
            // Save to localStorage
            localStorage.setItem('ghostmesh_name', name);
            localStorage.setItem('ghostmesh_id', id);
            localStorage.setItem('ghostmesh_password', password);
            localStorage.setItem('ghostmesh_contacts', JSON.stringify({}));
            localStorage.setItem('ghostmesh_messages', JSON.stringify({}));
            
            showApp();
            initializeNetwork();
        }

        // Show error
        function showError(element, message) {
            element.textContent = message;
            element.classList.remove('hidden');
        }

        // Generate user ID
        function generateUserId() {
            return 'user_' + Math.random().toString(36).substring(2, 15) + 
                   Math.random().toString(36).substring(2, 15);
        }

        // Show main app
        function showApp() {
            document.getElementById('onboarding').classList.add('hidden');
            document.getElementById('app').classList.remove('hidden');
            
            // Update UI
            document.getElementById('my-name').textContent = AppState.name;
            document.getElementById('my-avatar').textContent = getInitials(AppState.name);
            document.getElementById('my-id-display').textContent = AppState.id;
            
            // Setup event listeners
            setupEventListeners();
            
            // Render contacts
            renderContacts();
        }

        // Setup event listeners
        function setupEventListeners() {
            // Message input
            const messageInput = document.getElementById('message-input');
            messageInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            messageInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 120) + 'px';
            });
            
            // Search contacts
            document.getElementById('search-contacts').addEventListener('input', function() {
                filterContacts(this.value.toLowerCase());
            });
            
            // File attachment (click on send button when empty)
            document.getElementById('send-btn').addEventListener('contextmenu', function(e) {
                e.preventDefault();
                attachFile();
            });
        }

        // Initialize network/PeerJS
        function initializeNetwork() {
            console.log("Initializing network...");
            
            // Check if PeerJS is loaded
            if (typeof Peer === 'undefined') {
                console.error("PeerJS not loaded!");
                showToast("‚ö†Ô∏è Network features limited. PeerJS failed to load.", 5000);
                
                // Update status
                updateConnectionStatus('error', 'Network Error');
                return;
            }
            
            try {
                // Create peer instance
                AppState.peer = new Peer(AppState.id, {
                    debug: 0, // Set to 2 for more logging
                    config: {
                        iceServers: [
                            { urls: 'stun:stun.l.google.com:19302' },
                            { urls: 'stun:stun1.l.google.com:19302' }
                        ]
                    }
                });
                
                // Peer event handlers
                AppState.peer.on('open', function(id) {
                    console.log("‚úÖ Connected to Peer server with ID:", id);
                    AppState.isOnline = true;
                    updateConnectionStatus('online', 'Online');
                    showToast("Connected to network");
                });
                
                AppState.peer.on('connection', handleIncomingConnection);
                
                AppState.peer.on('error', function(err) {
                    console.error("Peer error:", err);
                    
                    if (err.type === 'unavailable-id') {
                        // Generate new ID
                        AppState.id = generateUserId();
                        localStorage.setItem('ghostmesh_id', AppState.id);
                        initializeNetwork(); // Retry
                    } else {
                        updateConnectionStatus('offline', 'Offline');
                        showToast("Network error: " + err.type);
                    }
                });
                
                AppState.peer.on('disconnected', function() {
                    console.log("Disconnected from Peer server");
                    AppState.isOnline = false;
                    updateConnectionStatus('offline', 'Reconnecting...');
                    
                    // Try to reconnect
                    setTimeout(function() {
                        if (AppState.peer && AppState.peer.disconnected) {
                            AppState.peer.reconnect();
                        }
                    }, 5000);
                });
                
            } catch (error) {
                console.error("Failed to initialize Peer:", error);
                showToast("‚ö†Ô∏è Network initialization failed. Using offline mode.");
                updateConnectionStatus('error', 'Offline Mode');
            }
        }

        // Update connection status in UI
        function updateConnectionStatus(status, text) {
            const dot = document.getElementById('status-dot');
            const statusText = document.getElementById('network-status');
            
            dot.className = 'status-dot ' + status;
            statusText.textContent = text;
            
            // Update color based on status
            switch(status) {
                case 'online':
                    statusText.style.color = '#00a884';
                    break;
                case 'offline':
                    statusText.style.color = '#8696a0';
                    break;
                case 'connecting':
                    statusText.style.color = '#ffa500';
                    break;
                case 'error':
                    statusText.style.color = '#ff4444';
                    break;
            }
        }

        // Handle incoming connection
        function handleIncomingConnection(conn) {
            console.log("Incoming connection from:", conn.peer);
            
            conn.on('open', function() {
                // Send our info
                conn.send({
                    type: 'handshake',
                    id: AppState.id,
                    name: AppState.name,
                    timestamp: Date.now()
                });
                
                // Store connection
                AppState.connections[conn.peer] = conn;
                updateContactStatus(conn.peer, true);
            });
            
            conn.on('data', function(data) {
                handleIncomingData(conn.peer, data);
            });
            
            conn.on('close', function() {
                console.log("Connection closed with:", conn.peer);
                delete AppState.connections[conn.peer];
                updateContactStatus(conn.peer, false);
            });
            
            conn.on('error', function(err) {
                console.error("Connection error with", conn.peer, ":", err);
            });
        }

        // Handle incoming data
        function handleIncomingData(senderId, data) {
            console.log("Data from", senderId, ":", data);
            
            if (data.type === 'handshake') {
                // Add or update contact
                addContact(senderId, data.name, data.id);
                
                // Send response if we have an active connection
                const conn = AppState.connections[senderId];
                if (conn) {
                    conn.send({
                        type: 'handshake_response',
                        id: AppState.id,
                        name: AppState.name,
                        timestamp: Date.now()
                    });
                }
                
            } else if (data.type === 'handshake_response') {
                // Contact responded
                addContact(senderId, data.name, data.id);
                
            } else if (data.type === 'message') {
                // Handle text message
                receiveMessage(senderId, {
                    text: data.text,
                    timestamp: data.timestamp || Date.now()
                });
                
            } else if (data.type === 'file') {
                // Handle file
                receiveMessage(senderId, {
                    type: 'file',
                    name: data.name,
                    fileType: data.fileType,
                    size: data.size,
                    data: data.data,
                    timestamp: data.timestamp || Date.now()
                });
            }
        }

        // Add contact
        function addContact(peerId, name, contactId) {
            // Check if contact exists with different peerId (reconnection)
            let existingPeerId = null;
            for (const [pid, contact] of Object.entries(AppState.contacts)) {
                if (contact.id === contactId && pid !== peerId) {
                    existingPeerId = pid;
                    break;
                }
            }
            
            if (existingPeerId) {
                console.log("Contact reconnected. Migrating from", existingPeerId, "to", peerId);
                
                // Migrate messages
                if (AppState.messages[existingPeerId]) {
                    AppState.messages[peerId] = AppState.messages[existingPeerId];
                    delete AppState.messages[existingPeerId];
                }
                
                // Update active chat if needed
                if (AppState.activeChat === existingPeerId) {
                    AppState.activeChat = peerId;
                    setTimeout(() => loadChat(peerId), 100);
                }
                
                // Delete old contact
                delete AppState.contacts[existingPeerId];
                delete AppState.connections[existingPeerId];
            }
            
            // Add/update contact
            AppState.contacts[peerId] = {
                id: contactId,
                name: name,
                online: AppState.connections[peerId] ? true : false,
                lastSeen: Date.now()
            };
            
            // Save
            saveContacts();
            saveMessages();
            
            // Update UI
            renderContacts();
            
            // If this is active chat, update header
            if (AppState.activeChat === peerId) {
                updateChatHeader(peerId);
            }
        }

        // Connect to peer
        function connectToPeer(peerId) {
            if (!AppState.peer || !AppState.peer.id) {
                showToast("Not connected to network");
                return null;
            }
            
            if (AppState.connections[peerId]) {
                return AppState.connections[peerId];
            }
            
            try {
                const conn = AppState.peer.connect(peerId, {
                    reliable: true,
                    serialization: 'json'
                });
                
                conn.on('open', function() {
                    console.log("Connected to", peerId);
                    
                    // Send handshake
                    conn.send({
                        type: 'handshake',
                        id: AppState.id,
                        name: AppState.name,
                        timestamp: Date.now()
                    });
                    
                    // Store connection
                    AppState.connections[peerId] = conn;
                    updateContactStatus(peerId, true);
                });
                
                conn.on('data', function(data) {
                    handleIncomingData(peerId, data);
                });
                
                conn.on('close', function() {
                    console.log("Connection closed with", peerId);
                    delete AppState.connections[peerId];
                    updateContactStatus(peerId, false);
                });
                
                conn.on('error', function(err) {
                    console.error("Connection error:", err);
                    showToast("Failed to connect");
                });
                
                return conn;
                
            } catch (error) {
                console.error("Connection failed:", error);
                showToast("Connection failed");
                return null;
            }
        }

        // Send message
        function sendMessage() {
            if (!AppState.activeChat) {
                showToast("Select a contact first");
                return;
            }
            
            const input = document.getElementById('message-input');
            const text = input.value.trim();
            
            if (!text) {
                // If no text, try to attach file
                attachFile();
                return;
            }
            
            // Create message
            const message = {
                text: text,
                timestamp: Date.now(),
                type: 'text'
            };
            
            // Add to UI immediately
            addMessageToUI(AppState.activeChat, message, 'sent');
            
            // Send via connection if available
            const conn = AppState.connections[AppState.activeChat];
            if (conn && conn.open) {
                conn.send({
                    type: 'message',
                    text: text,
                    timestamp: message.timestamp
                });
            } else {
                // Try to connect and send
                const newConn = connectToPeer(AppState.activeChat);
                if (newConn) {
                    setTimeout(() => {
                        if (newConn.open) {
                            newConn.send({
                                type: 'message',
                                text: text,
                                timestamp: message.timestamp
                            });
                        }
                    }, 500);
                } else {
                    showToast("Message saved locally (recipient offline)");
                }
            }
            
            // Clear input
            input.value = '';
            input.style.height = 'auto';
            
            // Save
            saveMessages();
        }

        // Attach file
        function attachFile() {
            const input = document.createElement('input');
            input.type = 'file';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    sendFile(file);
                }
            };
            input.click();
        }

        // Send file
        function sendFile(file) {
            if (!AppState.activeChat) {
                showToast("Select a contact first");
                return;
            }
            
            if (file.size > 50 * 1024 * 1024) { // 50MB limit
                showToast("File too large (max 50MB)");
                return;
            }
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                // Create message
                const message = {
                    type: 'file',
                    name: file.name,
                    fileType: file.type,
                    size: file.size,
                    data: e.target.result,
                    timestamp: Date.now()
                };
                
                // Add to UI
                addMessageToUI(AppState.activeChat, message, 'sent');
                
                // Send via connection
                const conn = AppState.connections[AppState.activeChat];
                if (conn && conn.open) {
                    conn.send({
                        type: 'file',
                        name: file.name,
                        fileType: file.type,
                        size: file.size,
                        data: e.target.result,
                        timestamp: message.timestamp
                    });
                } else {
                    showToast("File saved locally (recipient offline)");
                }
                
                // Save
                saveMessages();
            };
            
            reader.onerror = function() {
                showToast("Failed to read file");
            };
            
            reader.readAsDataURL(file);
        }

        // Receive message
        function receiveMessage(senderId, messageData) {
            // Add to UI
            addMessageToUI(senderId, messageData, 'received');
            
            // Save
            saveMessages();
            
            // Show notification if not active chat
            if (AppState.activeChat !== senderId) {
                const contact = AppState.contacts[senderId];
                if (contact) {
                    showToast(`New message from ${contact.name}`);
                }
            }
        }

        // Add message to UI
        function addMessageToUI(peerId, messageData, direction) {
            // Initialize messages array
            if (!AppState.messages[peerId]) {
                AppState.messages[peerId] = [];
            }
            
            // Create message object
            const message = {
                id: Date.now(),
                ...messageData,
                direction: direction,
                timestamp: messageData.timestamp || Date.now()
            };
            
            // Add to storage
            AppState.messages[peerId].push(message);
            
            // If active chat, render it
            if (AppState.activeChat === peerId) {
                renderMessage(message);
            }
            
            // Update contact last message
            updateContactLastMessage(peerId, message);
        }

        // Render message
        function renderMessage(message) {
            const container = document.getElementById('messages-container');
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${message.direction}`;
            
            if (message.type === 'file') {
                const isImage = message.fileType.startsWith('image/');
                
                if (isImage) {
                    messageDiv.innerHTML = `
                        <div class="image-message" onclick="openImage('${message.data}')">
                            <img src="${message.data}" alt="${message.name}">
                        </div>
                        <div class="message-time">${formatTime(message.timestamp)}</div>
                    `;
                } else {
                    messageDiv.innerHTML = `
                        <div class="file-message">
                            <div class="file-info">
                                <div class="file-icon">${getFileIcon(message.fileType)}</div>
                                <div class="file-details">
                                    <div class="file-name">${escapeHTML(message.name)}</div>
                                    <div class="file-size">${formatBytes(message.size)}</div>
                                </div>
                                <button class="download-btn" onclick="downloadFile('${message.data}', '${message.name}')">
                                    Download
                                </button>
                            </div>
                        </div>
                        <div class="message-time">${formatTime(message.timestamp)}</div>
                    `;
                }
            } else {
                // Text message
                messageDiv.innerHTML = `
                    <div>${escapeHTML(message.text)}</div>
                    <div class="message-time">${formatTime(message.timestamp)}</div>
                `;
            }
            
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }

        // Load chat
        function loadChat(peerId) {
            AppState.activeChat = peerId;
            
            // Show active chat UI
            document.getElementById('welcome-screen').classList.add('hidden');
            document.getElementById('active-chat').classList.remove('hidden');
            
            // Update header
            updateChatHeader(peerId);
            
            // Clear and load messages
            const container = document.getElementById('messages-container');
            container.innerHTML = '';
            
            if (AppState.messages[peerId]) {
                AppState.messages[peerId].forEach(message => {
                    renderMessage(message);
                });
            }
            
            // Connect if not connected
            if (!AppState.connections[peerId]) {
                connectToPeer(peerId);
            }
            
            // Update contacts list
            document.querySelectorAll('.contact').forEach(c => {
                c.classList.remove('active');
            });
            document.querySelector(`.contact[data-peer="${peerId}"]`)?.classList.add('active');
        }

        // Update chat header
        function updateChatHeader(peerId) {
            const contact = AppState.contacts[peerId];
            if (!contact) return;
            
            document.getElementById('chat-name').textContent = contact.name;
            document.getElementById('chat-avatar').textContent = getInitials(contact.name);
            document.getElementById('chat-status').textContent = contact.online ? 'Online' : 'Offline';
            document.getElementById('chat-status').style.color = contact.online ? '#00a884' : '#8696a0';
        }

        // Render contacts
        function renderContacts() {
            const container = document.getElementById('contacts-list');
            const loading = document.getElementById('contacts-loading');
            
            if (loading) {
                loading.remove();
            }
            
            container.innerHTML = '';
            
            const contacts = Object.entries(AppState.contacts);
            
            if (contacts.length === 0) {
                container.innerHTML = `
                    <div class="welcome" style="padding: 40px 20px;">
                        <div style="font-size: 48px; opacity: 0.3; margin-bottom: 20px;">üë§</div>
                        <div style="color: #8696a0;">No contacts yet</div>
                        <button onclick="addContactManually()" style="margin-top: 20px; width: auto; padding: 8px 16px;">
                            Add Contact
                        </button>
                    </div>
                `;
                return;
            }
            
            // Sort by last message time
            contacts.sort((a, b) => {
                const timeA = AppState.messages[a[0]]?.[AppState.messages[a[0]].length - 1]?.timestamp || 0;
                const timeB = AppState.messages[b[0]]?.[AppState.messages[b[0]].length - 1]?.timestamp || 0;
                return timeB - timeA;
            });
            
            contacts.forEach(([peerId, contact]) => {
                const lastMessage = AppState.messages[peerId]?.[AppState.messages[peerId].length - 1];
                
                let preview = 'No messages yet';
                if (lastMessage) {
                    if (lastMessage.type === 'file') {
                        preview = 'üìé ' + lastMessage.name;
                    } else if (lastMessage.text) {
                        preview = lastMessage.text.length > 30 ? 
                            lastMessage.text.substring(0, 30) + '...' : lastMessage.text;
                    }
                }
                
                const contactDiv = document.createElement('div');
                contactDiv.className = 'contact';
                contactDiv.dataset.peer = peerId;
                contactDiv.onclick = () => loadChat(peerId);
                
                if (AppState.activeChat === peerId) {
                    contactDiv.classList.add('active');
                }
                
                contactDiv.innerHTML = `
                    <div class="contact-avatar">${getInitials(contact.name)}</div>
                    <div class="contact-info">
                        <div class="contact-name">${escapeHTML(contact.name)}</div>
                        <div class="contact-last">${escapeHTML(preview)}</div>
                    </div>
                    ${contact.online ? '<div class="status-dot online" style="margin-right: 10px;"></div>' : ''}
                `;
                
                container.appendChild(contactDiv);
            });
        }

        // Filter contacts
        function filterContacts(query) {
            document.querySelectorAll('.contact').forEach(contact => {
                const name = contact.querySelector('.contact-name').textContent.toLowerCase();
                const lastMsg = contact.querySelector('.contact-last').textContent.toLowerCase();
                
                if (name.includes(query) || lastMsg.includes(query)) {
                    contact.style.display = 'flex';
                } else {
                    contact.style.display = 'none';
                }
            });
        }

        // Update contact last message
        function updateContactLastMessage(peerId, message) {
            const contact = AppState.contacts[peerId];
            if (!contact) return;
            
            // This will trigger re-render of contacts
            renderContacts();
        }

        // Update contact status
        function updateContactStatus(peerId, isOnline) {
            const contact = AppState.contacts[peerId];
            if (contact) {
                contact.online = isOnline;
                contact.lastSeen = Date.now();
                
                // Save
                saveContacts();
                
                // Update UI if active chat
                if (AppState.activeChat === peerId) {
                    updateChatHeader(peerId);
                }
                
                // Re-render contacts
                renderContacts();
            }
        }

        // Add contact manually
        function addContactManually() {
            const peerId = prompt("Enter the contact's Peer ID:");
            if (!peerId) return;
            
            const name = prompt("Enter contact name:") || "Unknown";
            
            addContact(peerId, name, peerId);
            connectToPeer(peerId);
            loadChat(peerId);
        }

        // Copy my ID
        function copyMyId() {
            navigator.clipboard.writeText(AppState.id)
                .then(() => showToast("ID copied to clipboard"))
                .catch(() => {
                    // Fallback
                    const textArea = document.createElement('textarea');
                    textArea.value = AppState.id;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    showToast("ID copied");
                });
        }

        // Save contacts to storage
        function saveContacts() {
            localStorage.setItem('ghostmesh_contacts', JSON.stringify(AppState.contacts));
        }

        // Save messages to storage
        function saveMessages() {
            localStorage.setItem('ghostmesh_messages', JSON.stringify(AppState.messages));
        }

        // Utility functions
        function escapeHTML(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatTime(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        function formatBytes(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }

        function getInitials(name) {
            return name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
        }

        function getFileIcon(mimeType) {
            if (mimeType.includes('pdf')) return 'üìÑ';
            if (mimeType.includes('image')) return 'üñºÔ∏è';
            if (mimeType.includes('video')) return 'üé¨';
            if (mimeType.includes('audio')) return 'üéµ';
            if (mimeType.includes('zip') || mimeType.includes('rar') || mimeType.includes('7z')) return 'üóúÔ∏è';
            if (mimeType.includes('word') || mimeType.includes('document')) return 'üìù';
            if (mimeType.includes('excel') || mimeType.includes('spreadsheet')) return 'üìä';
            if (mimeType.includes('powerpoint') || mimeType.includes('presentation')) return 'üìΩÔ∏è';
            return 'üìé';
        }

        function openImage(src) {
            window.open(src, '_blank');
        }

        function downloadFile(dataUrl, fileName) {
            const link = document.createElement('a');
            link.href = dataUrl;
            link.download = fileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function showToast(message, duration = 3000) {
            // Remove existing toast
            const existing = document.querySelector('.toast');
            if (existing) existing.remove();
            
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.remove();
                }
            }, duration);
        }

        // Export functions to global scope
        window.sendMessage = sendMessage;
        window.copyMyId = copyMyId;
        window.openImage = openImage;
        window.downloadFile = downloadFile;
        window.addContactManually = addContactManually;
    </script>
</body>
</html>
